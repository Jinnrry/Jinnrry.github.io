---
layout:     post
title:      "两次灾难性的项目开发经历复盘"
subtitle:   " 焦油坑的开发经历"
date:       2020-11-05 12:00:00
author:     "Jinnrry"
header-img: "img/17.jpg"
catalog: true
tags:
    - 工作经历
---
> 史前史中,没有别的场景比巨兽在焦油坑中垂死挣扎的场面更令人震撼。上帝见证着
恐龙、猛犸象、剑齿虎在焦油中挣扎。它们挣扎得越是猛烈,焦油纠缠得越紧,没有任何猛
兽足够强壮或具有足够的技巧,能够挣脱束缚,它们最后都沉到了坑底。    --<<人月神话>>

在这里复盘总结我所经历过的两次最为灾难性的程序开发经历。之所以称之为灾难，是因为以下几个问题十分严重：

1. 项目开发过程中严重延期，且无法预估到底什么时候能结束
2. 项目提测质量十分差，测试介入第一天就有上百个bug单
3. bug修复速度慢，测试新开的bug单远多于关闭的bug单
4. 代码逻辑频繁改动，测试过程中还在修改业务逻辑



项目就如同这样一个焦油坑，好在最后，我没有一直陷在其中，最终都成功爬了出来。

## 项目一：马蜂窝足迹2.0

### 背景

马蜂窝足迹作为马蜂窝品牌级别的项目，从立项开始就收到CEO层面的高度关注。足迹2.0更是基于1.0版本的全面迭代，2.0版本深化了地图上面的交互逻辑，增加了基于地图的各类玩法，同时与笔记互动，在宣传公司品牌的同时达到引流目的。

项目开始，部门leader亲自指挥，调集了各个部门最核心的开发人员提供支持。同时，由于项目的意义重大，也规定出项目得最快时间上线。当我进入项目的时候，项目一共11个研发，4个前端，3个后端，4个测试项目排期已经确定，基本上就是3周时间上线。

排期会基本上就是开发和测试之间商量各自要多少时间。


### 初期

项目开始，我们3个后端开了一个短会，上一版本的开发介绍了业务背景，然后以前讨论了项目技术方案，确定了每个人的分工，整个会议大致一个小时就结束了。各自有了各自的分工，然后大家就立马开始了coding。


### 第一次延期

大致在两周后，到了提测的时间点，第一个问题出现了，项目进度大致不足一半，完全没法进入提测。这时，有好几个问题摆在我们面前，

1、足迹在地图上面必须使用正六边形展示，以前调研使用uber的h3算法绘制六边形，但是h3算法绘制出来的完全不是正六边形，会有极大的形变。

2、由于六边形算法没解决，前端也没法完成动画相关的开发

3、国界线附件的poi归属问题（由于gcj和wgs坐标系偏移，无法根据经纬度准确定位出国家线附件的poi属于哪个国家，对于敏感地区，这会带来严重的政治问题）

这时，由于这几个问题根本找不到解决方案，完全没法给出预估提测时间，因此灾难的第一个问题出现了，项目开发过程中严重延期，且无法预估到底什么时候能结束。这种状态大致持续了一周多，我们最终终于找出了解决方案：

1、对于算法问题，我在经过各方调研后，决定自己动手基于墨卡托坐标系来实现一个分形定位算法，保证展示出正六边形。（这个算法后续申请了专利，包含分形和索引两部分）。
2、对于poi归属问题，跟产品多次沟通后决定，直接隐藏掉国界线线附近的poi。

这两点确定以后，就开始了算法推导和代码实现，差不多花了1周的时间。而对于隐藏国界线附近的poi这个方案，又引出了另外一个问题，如何判断一个poi是否是国界线附近？这又是一个难题，因为国界线都是不规则曲线，根本没办法直接确定一个poi离最近的国界线距离是多少。

对于第二个问题，还好我是地图服务部门过来的，我找到了组内同事，经过多次讨论，决定引入goole s2算法来计算距离问题，而封装s2接口，导入数据，生成国界线索引等等问题，大致又花了3天左右的时间。

最终大致在延期半个月后，我们基本上解决掉了主要的问题，完成了整体业务流程的开发。

这时，领导找到我们，问能不能确定什么时候上线，测试那边给出以前的排期时间，一周完成测试，测试完就上线。


### 第二次延期

而提测后，第一天我们就傻眼了，4个测试，第一天就提了100+的bug单，而我们一天能修复的，大致也就20个不到，这里，第二第三个灾难出现了，项目提测质量十分差，测试介入第一天就有上百个bug单，bug修复速度慢，测试新开的bug单远多于关闭的bug单。

又过了3天，bug数到达顶峰，大概有200+未解决的bug，这3天测试新增bug单的速度虽然放缓，但是依旧高于开发解决速度。到这里领导也坐不住了，给项目派来了人力管理，同时决定加派研发人手，里面从别的项目中抽出了三个后端开发过来专门帮忙解bug。

而由于新人加入，这里项目又停下了2天去给新人梳理业务逻辑，同时分析我们项目架构是否存在问题。经过2天的梳理，最终得到结论，设计没问题，大家继续解bug。

大致到了第二周测试结束，bug已经解决了大部分，仅剩少量待修复，而且由于每天稳定的bug关闭数，大家都觉得上线就在眼前。这时我们决定开始准备上线计划，而本来简简单单的上线计划，这次再次成为大问题。由于足迹1.0的用户数据和2.0的用户数据完全不兼容。


### 第三次延期

线上根本不能直接上线。而如何完全线上不停机更新，用户数据平滑迁移，再次成为难题。

经过大家的讨论，最终我们决定，分离2.0的数据库，2.0新起数据库，使用脚本把1.0的数据更新到2.0的库中，这样保证线上升级无感知，同时具备紧急情况的回滚能力。然后就是迁移脚本编写、测试，大致又花了两三天的时间。

而由于有库（这里的库不止MySQL，还有ES，部分数据以前在ES里面，需要迁移到MySQL）的改动，又涉及到了业务代码逻辑的改动。业务代码重写以后，又需要测试人员重测以前的所有逻辑。

最终在大致延期一个多月以后，终于完成了最终的上线。延期的这一个月中，所有开发、测试、产品，基本上都每天加班，周末无休。



## 项目二：小米商家返利系统

### 背景

以前小米专卖店的返利计算全部都是由财务使用excel计算，费时费力，同时经常算错，和商家自己算的数据经常对不上。随着小米线下门店的增多，迫切的需要信息化系统支持。

### 初期

这个项目第一时间并不是由我负责的，前两次需求会我都没有参加，但是由于相关同事请假，这个项目被分到了我头上。